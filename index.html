<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime Chat 💬</title>
<style>
  body { background:#0a0a0a; color:#fff; font-family:Arial,sans-serif; display:flex; flex-direction:column; height:100vh; margin:0; }
  #messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
  .msg { max-width:80%; padding:10px; border-radius:10px; word-wrap:break-word; position:relative; }
  .me { background:#1e90ff; align-self:flex-end; }
  .other { background:#333; align-self:flex-start; }
  .time { font-size:0.7em; color:#ccc; margin-top:5px; text-align:right; }
  #inputArea { display:flex; padding:10px; background:#111; }
  input { flex:1; padding:10px; border:none; border-radius:5px; background:#222; color:#fff; outline:none; }
  button { background:#1e90ff; color:#fff; border:none; padding:10px 15px; margin-left:10px; border-radius:5px; cursor:pointer; font-weight:bold; }
  .deleteBtn { position:absolute; top:5px; right:8px; font-size:12px; background:rgba(0,0,0,0.3); border:none; color:#fff; border-radius:5px; padding:2px 6px; cursor:pointer; }
  #typing { padding:5px 10px; font-size:0.9em; color:#aaa; font-style:italic; }
  #authSection { margin:auto; text-align:center; }
  #chatSection { display:none; flex-direction:column; height:100%; }
</style>
</head>
<body>

<!-- 🔐 AUTH SECTION -->
<div id="authSection">
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Password"><br><br>
  <button id="signupBtn">Signup</button>
  <button id="loginBtn">Login</button>
</div>

<!-- 💬 CHAT SECTION -->
<div id="chatSection">
  <div style="display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px;">
    <h3>Realtime Chat 💬</h3>
    <button id="logoutBtn">Logout</button>
  </div>

  <div id="messages"></div>
  <div id="typing"></div>

  <div id="inputArea">
    <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { 
    getDatabase, ref, push, onChildAdded, remove, onChildRemoved, onValue, set 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyA_IGhhpYGsJDy1M9VPH-NXY561BF31mgg",
    authDomain: "wechat-eee4d.firebaseapp.com",
    databaseURL: "https://wechat-eee4d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "wechat-eee4d",
    storageBucket: "wechat-eee4d.firebasestorage.app",
    messagingSenderId: "156838661275",
    appId: "1:156838661275:web:3d0cf4f3b402391801ca3e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const chatRef = ref(db, "messages");
  const typingRef = ref(db, "typing");

  const authSection = document.getElementById("authSection");
  const chatSection = document.getElementById("chatSection");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const messagesDiv = document.getElementById("messages");
  const typingDiv = document.getElementById("typing");
  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");

  let username = "";

  // 🧠 Auth State Check
  onAuthStateChanged(auth, (user) => {
    if (user) {
      username = user.email.split("@")[0];
      authSection.style.display = "none";
      chatSection.style.display = "flex";
    } else {
      authSection.style.display = "block";
      chatSection.style.display = "none";
    }
  });

  // 🔹 Signup
  signupBtn.onclick = () => {
    createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
      .then(() => alert("Signup successful ✅"))
      .catch(err => alert(err.message));
  };

  // 🔹 Login
  loginBtn.onclick = () => {
    signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
      .catch(err => alert(err.message));
  };

  // 🔹 Logout
  logoutBtn.onclick = () => signOut(auth);

  // 💬 Send Message
  sendBtn.onclick = () => {
    const text = msgInput.value.trim();
    if (text === "") return;
    const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const newMsg = push(chatRef);
    set(newMsg, { id: newMsg.key, user: username, text: text, time: time });
    msgInput.value = "";
    set(typingRef, { user: username, typing: false });
  };

  // 📩 Show Messages
  onChildAdded(chatRef, (snapshot) => {
    const data = snapshot.val();
    const div = document.createElement("div");
    div.classList.add("msg", data.user === username ? "me" : "other");
    div.id = data.id;
    div.innerHTML = `
      <div>${data.text}</div>
      <div class="time">${data.user} • ${data.time}</div>
    `;
    if (data.user === username) {
      const delBtn = document.createElement("button");
      delBtn.classList.add("deleteBtn");
      delBtn.textContent = "🗑";
      delBtn.onclick = () => remove(ref(db, "messages/" + data.id));
      div.appendChild(delBtn);
    }
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // 🗑 Remove message
  onChildRemoved(chatRef, (snapshot) => {
    const msgDiv = document.getElementById(snapshot.key);
    if (msgDiv) msgDiv.remove();
  });

  // ⌨ Typing Indicator
  msgInput.addEventListener("input", () => {
    set(typingRef, { user: username, typing: msgInput.value.trim() !== "" });
  });
  onValue(typingRef, (snapshot) => {
    const data = snapshot.val();
    if (data && data.typing && data.user !== username) {
      typingDiv.textContent = `${data.user} is typing...`;
    } else typingDiv.textContent = "";
  });
</script>
</body>
</html>
