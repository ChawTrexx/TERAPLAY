<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Video Upload</title>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial,sans-serif;padding:20px;}
.box{max-width:600px;margin:20px auto;background:#111;padding:20px;border-radius:12px;box-shadow:0 0 12px #000;}
input,textarea{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:15px;}
button{padding:10px 18px;border-radius:8px;border:0;background:#5b4dff;color:#fff;font-size:15px;cursor:pointer;}
button:hover{opacity:0.8;}
label{color:#aaa;font-size:13px;}
#list{margin-top:25px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}
.video-item{background:#1b1b1b;padding:10px;border-radius:10px;text-align:center;box-shadow:0 0 8px #000;}
.video-item img{width:100%;height:120px;border-radius:6px;object-fit:cover;margin-bottom:6px;}
.delete-btn{background:#ff4444;color:white;padding:6px 10px;border-radius:6px;margin-top:6px;}
.delete-btn:hover{opacity:0.8;}
</style>
</head>
<body>

<div class="box">
<h2>Admin Upload Panel</h2>

<label>Upload Thumbnail</label>
<input type="file" id="imageUpload">
<p id="result" style="color:#72ff7e;margin-top:5px;font-size:13px;"></p>

<label>Thumbnail URL</label>
<input id="thumb" placeholder="Auto filled after image upload"/>

<label>Video Title</label>
<input id="title" placeholder="Video title"/>

<label>Video URL / Iframe Code</label>
<textarea id="video" placeholder="Dropbox link, direct URL, or iframe code"></textarea>

<button id="upload">UPLOAD TO DATABASE</button>
</div>

<h2 style="text-align:center;">All Videos</h2>
<div id="list"></div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBEo_4YpF_vLH8WtacVKU2YC1BaoIZ7TtI",
  authDomain: "videohosting-13776.firebaseapp.com",
  databaseURL: "https://videohosting-13776-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "videohosting-13776",
  storageBucket: "videohosting-13776.appspot.com",
  messagingSenderId: "992909501546",
  appId: "1:992909501546:web:3728b48ec4727a5679d613",
  measurementId: "G-Q0YQVS6QJ6"
};

// Initialize
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== ImgBB Upload + Auto Fill Thumbnail =====
async function uploadThumbnail() {
    const fileInput = document.getElementById("imageUpload");
    if (!fileInput.files.length) return;

    const file = fileInput.files[0];
    const apiKey = "28303bb2f8b9d2907349e5567b265f2d";

    const reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = async () => {
        const base64Data = reader.result.split(",")[1];

        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
            method: "POST",
            body: new URLSearchParams({ image: base64Data }),
        });

        const result = await response.json();

        if (result.status === 200) {
            const url = result.data.url;
            document.getElementById("thumb").value = url;
            document.getElementById("result").innerText = "✔ Thumbnail uploaded!";
        } else {
            alert("❌ ImgBB Upload Failed!");
        }
    };
}

document.getElementById("imageUpload").addEventListener("change", uploadThumbnail);


// ==== Detect Link Type ====
function convertDropboxURL(url){
    if(url.includes("dropbox.com")) {
        let u = new URL(url);

        // dl=0 ko raw=1 me change karo
        u.searchParams.set("raw", "1");

        // dl parameter hatao
        u.searchParams.delete("dl");

        return u.toString();
    }
    return url;
}

function detectType(input){
    input = input.trim();
    if(input.startsWith("<iframe")) return {type:"iframe",url:input.match(/src="([^"]+)"/)[1]};
    if(input.includes("dropbox.com")) return {type:"video",url:convertDropboxURL(input)};
    return {type:"video",url:input};
}

// ==== Upload to Firebase ====
document.getElementById("upload").addEventListener("click", async ()=>{
    const title = document.getElementById("title").value.trim();
    const thumb = document.getElementById("thumb").value.trim();
    const videoInput = document.getElementById("video").value.trim();

    if(!title || !thumb || !videoInput){
        alert("⚠ Fill all fields!");
        return;
    }

    const {type, url} = detectType(videoInput);

    await set(push(ref(db,"videos")),{
        title,thumbnail:thumb,type,url,timestamp:Date.now(),views:0
    });

    alert("✔ Uploaded Successfully!");
    location.reload();
});

// ==== Load Data ====
function loadList(){
    onValue(ref(db,"videos"), snap=>{
        const data = snap.val() || {};
        document.getElementById("list").innerHTML = Object.entries(data).map(([id,v])=>`
            <div class="video-item">
                <img src="${v.thumbnail}">
                <b>${v.title}</b><br>
                <small>${v.views} views</small><br>
                <button class="delete-btn" onclick="del('${id}')">DELETE</button>
            </div>
        `).join("");
    });
}

window.del = async id=>{
    if(confirm("Delete this video?")) await remove(ref(db,"videos/"+id));
};

loadList();
</script>
</body>
</html>
