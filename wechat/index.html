<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ™ï¸ Firebase Voice Call</title>
<style>
  body {background:#0a0f1e;color:#e6eef8;font-family:"Poppins",sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center;margin:0}
  button{padding:10px 20px;margin:8px;border-radius:10px;border:none;font-size:16px;cursor:pointer;transition:0.3s}
  button:hover{transform:scale(1.05)}
  #onlineCount{position:fixed;top:15px;right:15px;padding:8px 14px;border-radius:20px;background:linear-gradient(90deg,#06b6d4,#3b82f6,#9333ea);color:#fff;font-weight:bold;box-shadow:0 0 15px rgba(59,130,246,0.7)}
  #incomingPopup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);color:white;justify-content:center;align-items:center;flex-direction:column;z-index:10}
  #incomingPopup button{margin:10px;font-size:18px;padding:12px 25px}
  #acceptBtn{background:#10b981;color:#fff}
  #rejectBtn{background:#ef4444;color:#fff}
  #callControls{display:none;margin-top:15px}
  #muteBtn,#speakerBtn,#hangupBtn{background:#3b82f6;color:#fff}
  #timer{margin-top:10px;font-size:18px;color:#0ff;font-weight:bold}
</style>
</head>
<body>

<div id="onlineCount">ğŸ’« 0 Online</div>
<h2>ğŸ™ï¸ Real-time Voice Call</h2>
<p id="status">Status: Waiting...</p>

<button id="callBtn">ğŸ“ Start Call</button>

<div id="callControls">
  <button id="muteBtn">ğŸ”‡ Mute</button>
  <button id="hangupBtn">âŒ End Call</button>
  <div id="timer">00:00</div>
</div>

<audio id="remoteAudio" autoplay playsinline></audio>
<audio id="localAudio" autoplay muted playsinline style="display:none;"></audio>

<div id="incomingPopup">
  <h2>ğŸ“ Incoming Call...</h2>
  <div>
    <button id="acceptBtn">âœ… Receive</button>
    <button id="rejectBtn">âŒ Reject</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, onDisconnect, serverTimestamp, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// --- YOUR UPDATED CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyALvB7xgYjhBZi5y2JSBamDysNdgIm2mEo",
  authDomain: "wechat-54b07.firebaseapp.com",
  databaseURL: "https://wechat-54b07-default-rtdb.firebaseio.com",
  projectId: "wechat-54b07",
  storageBucket: "wechat-54b07.firebasestorage.app",
  messagingSenderId: "221397223557",
  appId: "1:221397223557:web:40703bc5c13dc1b2ab81ec"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elements
const callBtn = document.getElementById('callBtn');
const hangupBtn = document.getElementById('hangupBtn');
const muteBtn = document.getElementById('muteBtn');
const onlineCount = document.getElementById('onlineCount');
const incomingPopup = document.getElementById('incomingPopup');
const acceptBtn = document.getElementById('acceptBtn');
const rejectBtn = document.getElementById('rejectBtn');
const remoteAudio = document.getElementById('remoteAudio');
const callControls = document.getElementById('callControls');
const timerDisplay = document.getElementById('timer');
const statusText = document.getElementById('status');

let pc, localStream, isMuted = false, timerInterval, seconds = 0;
const uid = Math.random().toString(36).slice(2);
const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

// --- Presence Logic ---
const myPresenceRef = ref(db, 'presence/' + uid);
set(myPresenceRef, { online: true, last_active: serverTimestamp() });
onDisconnect(myPresenceRef).remove();
onValue(ref(db, 'presence'), (snap) => {
  onlineCount.textContent = `ğŸ’« ${snap.exists() ? Object.keys(snap.val()).length : 0} Online`;
});

// --- Timer ---
function startTimer() {
  seconds = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    timerDisplay.textContent = `${m}:${s}`;
  }, 1000);
}

// --- WebRTC Logic ---
async function setupWebRTC() {
  pc = new RTCPeerConnection(servers);
  
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      push(ref(db, `iceCandidates/${uid}`), event.candidate.toJSON());
    }
  };

  pc.ontrack = (event) => {
    remoteAudio.srcObject = event.streams[0];
  };

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
}

// Start Call (Caller)
callBtn.onclick = async () => {
  statusText.textContent = "Status: Calling...";
  await setupWebRTC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await set(ref(db, 'activeCall'), { offer, from: uid });
  callBtn.style.display = 'none';
  callControls.style.display = 'block';

  // Watch for answer
  onValue(ref(db, 'activeCall/answer'), async (snap) => {
    const answer = snap.val();
    if (answer && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
      statusText.textContent = "Status: Connected";
      startTimer();
    }
  });

  listenForIce(uid);
};

// Answer Call (Receiver)
onValue(ref(db, 'activeCall'), async (snap) => {
  const data = snap.val();
  if (data && data.from !== uid && !data.answer) {
    incomingPopup.style.display = 'flex';

    acceptBtn.onclick = async () => {
      incomingPopup.style.display = 'none';
      await setupWebRTC();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await set(ref(db, 'activeCall/answer'), answer);
      callBtn.style.display = 'none';
      callControls.style.display = 'block';
      statusText.textContent = "Status: Connected";
      startTimer();
      listenForIce(uid);
    };

    rejectBtn.onclick = async () => {
      incomingPopup.style.display = 'none';
      await remove(ref(db, 'activeCall'));
    };
  }
  
  // If call ended by other person
  if (!data && pc) {
    stopCall();
  }
});

// ICE Syncing
function listenForIce(myId) {
  onValue(ref(db, 'iceCandidates'), (snap) => {
    const allIce = snap.val();
    if (!allIce) return;
    Object.keys(allIce).forEach(peerId => {
      if (peerId !== myId) {
        Object.values(allIce[peerId]).forEach(candidate => {
          pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(() => {});
        });
      }
    });
  });
}

// End Call
async function stopCall() {
  clearInterval(timerInterval);
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  await remove(ref(db, 'activeCall'));
  await remove(ref(db, `iceCandidates`));
  location.reload(); 
}

hangupBtn.onclick = stopCall;

muteBtn.onclick = () => {
  isMuted = !isMuted;
  localStream.getAudioTracks()[0].enabled = !isMuted;
  muteBtn.textContent = isMuted ? "ğŸ”ˆ Unmute" : "ğŸ”‡ Mute";
};
</script>
</body>
</html>
