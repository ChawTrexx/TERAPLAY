<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Call Debugged</title>
<style>
  body { background:#0a192f; color:white; font-family:sans-serif; text-align:center; padding:20px; }
  #onlineCount { background: #007bff; padding: 10px; border-radius: 50px; display: inline-block; margin-bottom: 20px; }
  .btn { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 10px; border:none; background: #28a745; color: white; }
  #incomingPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; color:black; padding:30px; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.5); z-index:100; }
  #callControls { display:none; margin-top:20px; }
</style>
</head>
<body>

<div id="onlineCount">ğŸ’« Users Online: 0</div>
<h1>Firebase Voice Call</h1>
<p id="myIdDisplay"></p>

<button id="callBtn" class="btn">ğŸ“ Start Call</button>

<div id="callControls">
  <h2 id="status">Connected</h2>
  <button id="hangupBtn" class="btn" style="background:#dc3545;">âŒ End Call</button>
</div>

<div id="incomingPopup">
  <h2>ğŸ“ Incoming Call...</h2>
  <button id="acceptBtn" class="btn">âœ… Accept</button>
  <button id="rejectBtn" class="btn" style="background:#dc3545;">âŒ Reject</button>
</div>

<audio id="remoteAudio" autoplay></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove, onDisconnect, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyALvB7xgYjhBZi5y2JSBamDysNdgIm2mEo",
    authDomain: "wechat-54b07.firebaseapp.com",
    databaseURL: "https://wechat-54b07-default-rtdb.firebaseio.com",
    projectId: "wechat-54b07",
    storageBucket: "wechat-54b07.firebasestorage.app",
    messagingSenderId: "221397223557",
    appId: "1:221397223557:web:40703bc5c13dc1b2ab81ec"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const uid = "User_" + Math.floor(Math.random() * 1000);
  document.getElementById('myIdDisplay').innerText = "Your ID: " + uid;

  // --- ONLINE PRESENCE ---
  const myPresenceRef = ref(db, 'presence/' + uid);
  set(myPresenceRef, true);
  onDisconnect(myPresenceRef).remove();

  onValue(ref(db, 'presence'), (snap) => {
    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
    document.getElementById('onlineCount').innerText = `ğŸ’« Users Online: ${count}`;
  });

  // --- WEBRTC SETUP ---
  let pc, localStream;
  const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  async function startLocalStream() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  }

  async function createPeer(targetId) {
    pc = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    
    pc.ontrack = (e) => {
      document.getElementById('remoteAudio').srcObject = e.streams[0];
    };

    pc.onicecandidate = (e) => {
      if(e.candidate) {
        push(ref(db, 'ice/' + uid), e.candidate.toJSON());
      }
    };
  }

  // CALLER SIDE
  document.getElementById('callBtn').onclick = async () => {
    await startLocalStream();
    await createPeer();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    
    await set(ref(db, 'calls/active'), { offer, from: uid });
    document.getElementById('callBtn').style.display = 'none';
    document.getElementById('callControls').style.display = 'block';
    
    // Listen for answer
    onValue(ref(db, 'calls/active/answer'), async (snap) => {
      if(snap.exists() && !pc.currentRemoteDescription) {
        await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
      }
    });
    listenForIce();
  };

  // RECEIVER SIDE
  onValue(ref(db, 'calls/active'), async (snap) => {
    const data = snap.val();
    if(data && data.from !== uid && !data.answer) {
      document.getElementById('incomingPopup').style.display = 'block';
      
      document.getElementById('acceptBtn').onclick = async () => {
        document.getElementById('incomingPopup').style.display = 'none';
        await startLocalStream();
        await createPeer();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await set(ref(db, 'calls/active/answer'), answer.toJSON());
        document.getElementById('callBtn').style.display = 'none';
        document.getElementById('callControls').style.display = 'block';
        listenForIce();
      };
    }
    if(!data && pc) location.reload();
  });

  function listenForIce() {
    onValue(ref(db, 'ice'), (snap) => {
      if(!snap.exists()) return;
      Object.keys(snap.val()).forEach(id => {
        if(id !== uid) {
          Object.values(snap.val()[id]).forEach(cand => {
            pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e => {});
          });
        }
      });
    });
  }

  document.getElementById('hangupBtn').onclick = async () => {
    await remove(ref(db, 'calls/active'));
    await remove(ref(db, 'ice'));
    location.reload();
  };

</script>
</body>
</html>
