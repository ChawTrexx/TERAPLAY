<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Voice & Video Call</title>
<style>
  body { background:#0a192f; color:white; font-family:sans-serif; text-align:center; padding:20px; }
  #onlineUsers { background: #007bff; padding: 10px; border-radius: 15px; margin-bottom: 20px; display:inline-block; text-align:left; }
  .userBtn { padding:5px 10px; margin:3px; border-radius:10px; cursor:pointer; color:white; border:none; }
  .voiceBtn { background:#28a745; }
  .videoBtn { background:#ffc107; color:black; }
  #callControls { display:none; margin-top:20px; }
  #incomingPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:white; color:black; padding:30px; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.5); z-index:100; }
  .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 10px; border:none; margin:5px; }
  #localVideo, #remoteVideo { width: 300px; height: 200px; margin:10px; background:black; }
</style>
</head>
<body>

<h1>Firebase Voice & Video Call</h1>
<p id="myIdDisplay"></p>

<div id="onlineUsers">üí´ Online Users:<br></div>

<div id="callControls">
  <h2 id="status">Connected</h2>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video><br>
  <button id="hangupBtn" class="btn" style="background:#dc3545;">‚ùå End Call</button>
</div>

<div id="incomingPopup">
  <h2 id="incomingText">üìû Incoming Call...</h2>
  <button id="acceptBtn" class="btn">‚úÖ Accept</button>
  <button id="rejectBtn" class="btn" style="background:#dc3545;">‚ùå Reject</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, onDisconnect, push } 
  from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAC5RgES5ZCqgzCWGsSaNwaAR2o7JFjDrM",
  authDomain: "freecall-17619.firebaseapp.com",
  databaseURL: "https://freecall-17619-default-rtdb.firebaseio.com",
  projectId: "freecall-17619",
  storageBucket: "freecall-17619.firebasestorage.app",
  messagingSenderId: "945050839263",
  appId: "1:945050839263:web:b04def47bbed0f9e84e16a",
  measurementId: "G-Z433F9L74V"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- USER ID ---
const uid = "User_" + Math.floor(Math.random() * 1000);
document.getElementById('myIdDisplay').innerText = "Your ID: " + uid;

// --- PRESENCE ---
const myPresenceRef = ref(db, 'presence/' + uid);
set(myPresenceRef, true);
onDisconnect(myPresenceRef).remove();

// --- ONLINE USERS ---
const onlineUsersDiv = document.getElementById('onlineUsers');
function updateOnlineUsers(users) {
  onlineUsersDiv.innerHTML = "üí´ Online Users:<br>";
  for (let id of users) {
    if(id === uid) continue;
    // Voice button
    const voiceBtn = document.createElement('button');
    voiceBtn.className = "userBtn voiceBtn";
    voiceBtn.innerText = "üìû " + id;
    voiceBtn.onclick = () => initiateCall(id, "voice");
    onlineUsersDiv.appendChild(voiceBtn);

    // Video button
    const videoBtn = document.createElement('button');
    videoBtn.className = "userBtn videoBtn";
    videoBtn.innerText = "üé• " + id;
    videoBtn.onclick = () => initiateCall(id, "video");
    onlineUsersDiv.appendChild(videoBtn);
  }
}

onValue(ref(db, 'presence'), snap => {
  const users = snap.exists() ? Object.keys(snap.val()) : [];
  updateOnlineUsers(users);
});

// --- WEBRTC SETUP ---
let pc, localStream;
const servers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'turn:numb.viagenie.ca', username: 'webrtc@live.com', credential: 'muazkh' }
  ]
};
let currentCallTarget = null;
let callType = "voice";

// --- LOCAL STREAM ---
async function startLocalStream(type="voice") {
  if(type === "video") {
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
    document.getElementById('localVideo').srcObject = localStream;
    document.getElementById('localVideo').style.display = "block";
  } else {
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    document.getElementById('localVideo').style.display = "none";
  }
}

// --- CREATE PEER ---
async function createPeer() {
  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
    document.getElementById('remoteVideo').style.display = "block";
  };

  pc.onicecandidate = e => {
    if(e.candidate && currentCallTarget) {
      push(ref(db, `ice/${currentCallTarget}`), e.candidate.toJSON());
    }
  };
}

// --- INITIATE CALL ---
async function initiateCall(targetId, type="voice") {
  currentCallTarget = targetId;
  callType = type;
  await startLocalStream(type);
  await createPeer();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await set(ref(db, `calls/${targetId}`), { from: uid, offer: offer.toJSON(), type: type });
  document.getElementById('callControls').style.display = "block";
  listenForAnswer();
  listenForIce();
}

// --- LISTEN FOR ANSWER ---
function listenForAnswer() {
  onValue(ref(db, `calls/${uid}/answer`), async snap => {
    if(snap.exists() && pc && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
    }
  });
}

// --- RECEIVE CALL ---
onValue(ref(db, `calls/${uid}`), async snap => {
  const data = snap.val();
  if(data && data.from && !data.answer) {
    currentCallTarget = data.from;
    callType = data.type || "voice";
    document.getElementById('incomingText').innerText = `üìû Incoming ${callType} call from ${data.from}`;
    document.getElementById('incomingPopup').style.display = 'block';

    document.getElementById('acceptBtn').onclick = async () => {
      document.getElementById('incomingPopup').style.display = 'none';
      await startLocalStream(callType);
      await createPeer();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await set(ref(db, `calls/${data.from}/answer`), answer.toJSON());
      document.getElementById('callControls').style.display = 'block';
      listenForIce();
    };

    document.getElementById('rejectBtn').onclick = async () => {
      document.getElementById('incomingPopup').style.display = 'none';
      await remove(ref(db, `calls/${uid}`));
    };
  }
});

// --- ICE CANDIDATES ---
function listenForIce() {
  onValue(ref(db, `ice/${uid}`), snap => {
    if(!snap.exists()) return;
    Object.values(snap.val()).forEach(cand => {
      if(pc) pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e=>{});
    });
  });
}

// --- HANGUP ---
document.getElementById('hangupBtn').onclick = async () => {
  if(currentCallTarget){
    await remove(ref(db, `calls/${currentCallTarget}`));
    await remove(ref(db, `ice/${currentCallTarget}`));
  }
  await remove(ref(db, `calls/${uid}`));
  await remove(ref(db, `ice/${uid}`));
  location.reload();
};
</script>
</body>
</html>
