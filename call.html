<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§ Voice Call - Auto Connect</title>
  <style>
    body {
      background: #0a0f1e;
      color: #e6eef8;
      font-family: "Poppins", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    button {
      padding: 10px 18px;
      margin: 8px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { transform: scale(1.05); }
    #onlineCount {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 8px 14px;
      border-radius: 20px;
      background: linear-gradient(90deg,#06b6d4,#3b82f6,#9333ea);
      color: #fff;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(59,130,246,0.7);
    }
    #incomingPopup, #rejectedPopup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(6px);
      color: white;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
    }
    #incomingPopup button, #rejectedPopup button {
      margin: 10px;
      font-size: 18px;
      padding: 12px 25px;
    }
    #acceptBtn { background: #10b981; color: #fff; }
    #rejectBtn { background: #ef4444; color: #fff; }
  </style>
</head>
<body>
  <h2>ğŸ™ï¸ Firebase Auto Voice Call</h2>
  <div>
    <button id="startBtn">ğŸ¤ Start Mic</button>
    <button id="callBtn" disabled>ğŸ“ Start Call</button>
    <button id="hangupBtn" disabled>âŒ End Call</button>
  </div>

  <div id="onlineCount">ğŸ’« 0 Online</div>

  <audio id="remoteAudio" autoplay playsinline></audio>
  <audio id="localAudio" autoplay muted playsinline style="display:none;"></audio>

  <div id="incomingPopup">
    <h2>ğŸ“ Incoming Call...</h2>
    <div>
      <button id="acceptBtn">âœ… Receive</button>
      <button id="rejectBtn">âŒ Reject</button>
    </div>
  </div>

  <div id="rejectedPopup">
    <h2>âŒ Your call was rejected!</h2>
    <button onclick="document.getElementById('rejectedPopup').style.display='none'">OK</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove, onDisconnect, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_IGhhpYGsJDy1M9VPH-NXY561BF31mgg",
      authDomain: "wechat-eee4d.firebaseapp.com",
      databaseURL: "https://wechat-eee4d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wechat-eee4d",
      storageBucket: "wechat-eee4d.firebasestorage.app",
      messagingSenderId: "156838661275",
      appId: "1:156838661275:web:3d0cf4f3b402391801ca3e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const startBtn = document.getElementById('startBtn');
    const callBtn = document.getElementById('callBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const onlineCount = document.getElementById('onlineCount');
    const incomingPopup = document.getElementById('incomingPopup');
    const rejectedPopup = document.getElementById('rejectedPopup');
    const acceptBtn = document.getElementById('acceptBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const remoteAudio = document.getElementById('remoteAudio');
    const localAudio = document.getElementById('localAudio');

    let pc, localStream;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    const uid = Math.random().toString(36).slice(2);

    // ---- Presence ----
    const presenceRef = ref(db, 'presence/' + uid);
    set(presenceRef, { online: true, time: serverTimestamp() });
    onDisconnect(presenceRef).remove();
    onValue(ref(db, 'presence'), s => {
      const data = s.val() || {};
      onlineCount.textContent = `ğŸ’« ${Object.keys(data).length} Online`;
    });

    // ---- Start Mic ----
    startBtn.onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;
      startBtn.disabled = true;
      callBtn.disabled = false;
    };

    // ---- Call Start ----
    callBtn.onclick = async () => {
      pc = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.ontrack = e => remoteAudio.srcObject = e.streams[0];
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      const callRef = ref(db, 'activeCall');
      await set(callRef, { offer, from: uid, status: "ringing" });
      callBtn.disabled = true;
      hangupBtn.disabled = false;
    };

    // ---- Listen for Call Updates ----
    onValue(ref(db, 'activeCall'), async (snap) => {
      const data = snap.val();
      if (!data) return;

      // Incoming call
      if (data.from !== uid && data.offer && data.status === "ringing") {
        incomingPopup.style.display = 'flex';
        acceptBtn.onclick = async () => {
          incomingPopup.style.display = 'none';
          pc = new RTCPeerConnection(servers);
          localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
          pc.ontrack = e => remoteAudio.srcObject = e.streams[0];
          await pc.setRemoteDescription(data.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await update(ref(db, 'activeCall'), { answer, status: "connected" });
          hangupBtn.disabled = false;
        };
        rejectBtn.onclick = async () => {
          incomingPopup.style.display = 'none';
          await update(ref(db, 'activeCall'), { status: "rejected" });
          setTimeout(() => remove(ref(db, 'activeCall')), 3000);
        };
      }

      // Caller sees rejection
      if (data.from === uid && data.status === "rejected") {
        document.getElementById('rejectedPopup').style.display = 'flex';
        if (pc) pc.close();
        callBtn.disabled = false;
        hangupBtn.disabled = true;
        remove(ref(db, 'activeCall'));
      }

      // Answer received
      if (data.answer && data.from === uid && !pc.currentRemoteDescription) {
        await pc.setRemoteDescription(data.answer);
      }
    });

    // ---- Hangup ----
    hangupBtn.onclick = async () => {
      if (pc) pc.close();
      await remove(ref(db, 'activeCall'));
      hangupBtn.disabled = true;
      callBtn.disabled = false;
      alert('Call ended');
    };
  </script>
</body>
</html>
