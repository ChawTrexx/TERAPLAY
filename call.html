<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¥ Voice Call</title>
<style>
body {
  font-family: Poppins, sans-serif;
  background: #000;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  margin: 0;
}
h1 { color: #00ffc6; margin-bottom: 10px; }
button {
  background: #00ffc6;
  color: #000;
  border: none;
  padding: 12px 25px;
  font-size: 17px;
  border-radius: 10px;
  margin: 10px;
  cursor: pointer;
}
button:hover { background: #00cfa0; }
#callPopup, #rejectPopup {
  display: none;
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #111;
  border: 2px solid #00ffc6;
  padding: 25px;
  border-radius: 15px;
  text-align: center;
}
#onlineCount { margin: 10px; color: #aaa; }
#audioSwitch { display: none; margin-top: 15px; }
</style>
</head>
<body>

<h1>ğŸ”¥ Voice Call</h1>
<div id="onlineCount">Online: 0</div>
<button id="callBtn">ğŸ“ Start Call</button>
<button id="hangupBtn" style="display:none;">âŒ Hang Up</button>

<div id="callPopup">
  <h2 id="incomingText"></h2>
  <button id="acceptBtn">âœ… Accept</button>
  <button id="rejectBtn">âŒ Reject</button>
</div>

<div id="rejectPopup">
  <h2>âŒ Your call was rejected!</h2>
  <button onclick="document.getElementById('rejectPopup').style.display='none'">OK</button>
</div>

<audio id="remoteAudio" autoplay></audio>
<div id="audioSwitch">
  <button id="toggleOutput">ğŸ”Š Speaker</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_IGhhpYGsJDy1M9VPH-NXY561BF31mgg",
  authDomain: "wechat-eee4d.firebaseapp.com",
  databaseURL: "https://wechat-eee4d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wechat-eee4d",
  storageBucket: "wechat-eee4d.firebasestorage.app",
  messagingSenderId: "156838661275",
  appId: "1:156838661275:web:3d0cf4f3b402391801ca3e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const onlineRef = ref(db, "onlineUsers");
const callRef = ref(db, "calls");

const callBtn = document.getElementById("callBtn");
const hangupBtn = document.getElementById("hangupBtn");
const onlineCount = document.getElementById("onlineCount");
const callPopup = document.getElementById("callPopup");
const rejectPopup = document.getElementById("rejectPopup");
const incomingText = document.getElementById("incomingText");
const acceptBtn = document.getElementById("acceptBtn");
const rejectBtn = document.getElementById("rejectBtn");
const remoteAudio = document.getElementById("remoteAudio");
const audioSwitch = document.getElementById("audioSwitch");
const toggleOutput = document.getElementById("toggleOutput");

let localStream, pc, myId = Math.floor(Math.random() * 1000);
let currentCallKey = null;
let isSpeaker = false;

// === Track Online Users ===
const me = push(onlineRef);
set(me, { id: myId });
onDisconnect(me).remove();
onValue(onlineRef, s => {
  const u = s.val() || {};
  onlineCount.innerText = "Online: " + Object.keys(u).length;
});

// === CALL BUTTON ===
callBtn.onclick = async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch {
    alert("ğŸ¤ Microphone permission required!");
    return;
  }

  const snap = await fetch(db._delegate._repoInfo_.url + "/onlineUsers.json");
  const users = Object.values(await snap.json() || {});
  const others = users.filter(u => u.id !== myId);
  if (!others.length) return alert("No one online!");

  const target = others[0];
  const newCall = push(callRef);
  currentCallKey = newCall.key;
  set(newCall, { from: myId, to: target.id, status: "calling" });
  alert("ğŸ“ Calling user " + target.id + "...");
  startConnection(false);
};

// === Incoming / Call Updates ===
onValue(callRef, async (snap) => {
  const calls = snap.val();
  if (!calls) return;

  for (const key in calls) {
    const c = calls[key];
    if (c.to === myId && c.status === "calling") {
      currentCallKey = key;
      incomingText.innerText = `ğŸ“² Incoming call from ${c.from}`;
      callPopup.style.display = "block";
    }
    if (c.from === myId && c.status === "rejected") {
      rejectPopup.style.display = "block";
      remove(ref(db, "calls/" + key));
    }
  }
});

// === Accept / Reject ===
acceptBtn.onclick = async () => {
  callPopup.style.display = "none";
  update(ref(db, "calls/" + currentCallKey), { status: "accepted" });
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  startConnection(true);
};
rejectBtn.onclick = () => {
  callPopup.style.display = "none";
  update(ref(db, "calls/" + currentCallKey), { status: "rejected" });
};

// === WebRTC ===
async function startConnection(isReceiver) {
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; audioSwitch.style.display = "block"; };
  pc.onicecandidate = e => { if (e.candidate) set(ref(db, "calls/" + currentCallKey + "/candidate_" + myId), e.candidate.toJSON()); };

  const callDataRef = ref(db, "calls/" + currentCallKey);
  onValue(callDataRef, async (snap) => {
    const d = snap.val(); if (!d) return;
    if (d.offer && isReceiver) {
      await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      set(ref(db, "calls/" + currentCallKey + "/answer"), answer);
    } else if (d.answer && !isReceiver) {
      await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
    } else if (d["candidate_" + (isReceiver ? d.from : d.to)]) {
      await pc.addIceCandidate(new RTCIceCandidate(d["candidate_" + (isReceiver ? d.from : d.to)]));
    }
  });

  if (!isReceiver) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    set(ref(db, "calls/" + currentCallKey + "/offer"), offer);
  }

  callBtn.style.display = "none";
  hangupBtn.style.display = "block";
}

// === Hang Up ===
hangupBtn.onclick = () => {
  if (pc) pc.close();
  remove(ref(db, "calls/" + currentCallKey));
  callBtn.style.display = "block";
  hangupBtn.style.display = "none";
  audioSwitch.style.display = "none";
};

// === Speaker / Earpiece Switch ===
toggleOutput.onclick = async () => {
  if (!remoteAudio.setSinkId) return alert("Not supported!");
  const devices = await navigator.mediaDevices.enumerateDevices();
  const outs = devices.filter(d => d.kind === "audiooutput");
  if (outs.length < 2) return alert("No speaker device found.");
  isSpeaker = !isSpeaker;
  const target = outs[isSpeaker ? 1 : 0];
  await remoteAudio.setSinkId(target.deviceId);
  toggleOutput.textContent = isSpeaker ? "ğŸ§ Earpiece" : "ğŸ”Š Speaker";
};
</script>
</body>
</html>
