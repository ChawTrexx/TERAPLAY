<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔥 Voice Call</title>
<style>
body {
  background:#0a0f1e;
  color:#fff;
  font-family:Poppins,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
  text-align:center;
}
button {
  background:#00ffc6;
  color:#000;
  border:none;
  padding:12px 25px;
  font-size:17px;
  border-radius:10px;
  margin:10px;
  cursor:pointer;
}
button:hover {background:#00cfa0;}
#popup {
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(6px);
  justify-content:center;
  align-items:center;
  flex-direction:column;
}
#popup button{margin:10px;}
#online{position:fixed;top:10px;right:10px;background:#00ffc6;color:#000;padding:8px 14px;border-radius:20px;}
#audioSwitch{display:none;}
</style>
</head>
<body>

<h1>🎧 Firebase Voice Call</h1>
<div id="online">Online: 0</div>
<button id="startBtn">📞 Start Call</button>
<button id="hangupBtn" style="display:none;">❌ Hang Up</button>

<div id="popup">
  <h2>📲 Incoming Call...</h2>
  <button id="acceptBtn">✅ Accept</button>
  <button id="rejectBtn">❌ Reject</button>
</div>

<audio id="remoteAudio" autoplay></audio>
<div id="audioSwitch">
  <button id="toggleOutput">🔊 Speaker</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// 🔥 Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyA_IGhhpYGsJDy1M9VPH-NXY561BF31mgg",
  authDomain: "wechat-eee4d.firebaseapp.com",
  databaseURL: "https://wechat-eee4d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wechat-eee4d",
  storageBucket: "wechat-eee4d.firebasestorage.app",
  messagingSenderId: "156838661275",
  appId: "1:156838661275:web:3d0cf4f3b402391801ca3e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 🎛️ UI elements
const startBtn = document.getElementById("startBtn");
const hangupBtn = document.getElementById("hangupBtn");
const popup = document.getElementById("popup");
const acceptBtn = document.getElementById("acceptBtn");
const rejectBtn = document.getElementById("rejectBtn");
const onlineDiv = document.getElementById("online");
const remoteAudio = document.getElementById("remoteAudio");
const toggleOutput = document.getElementById("toggleOutput");
const audioSwitch = document.getElementById("audioSwitch");

// 🔊 Audio + RTC
let localStream, pc;
let isCaller = false;
let callId;
let myId = Math.random().toString(36).substr(2,8);
let isSpeaker = false;

// 🌐 Presence
const userRef = ref(db, "users/"+myId);
set(userRef, true);
onDisconnect(userRef).remove();
onValue(ref(db,"users"),s=>{
  const d=s.val()||{};
  onlineDiv.textContent=`Online: ${Object.keys(d).length}`;
});

// 📞 Start Call
startBtn.onclick = async ()=>{
  try {
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  } catch(e) {
    alert("🎤 Allow microphone to continue.");
    return;
  }
  const usersSnap = await fetch(db._delegate._repoInfo_.url+"/users.json");
  const users = await usersSnap.json() || {};
  const others = Object.keys(users).filter(id=>id!==myId);
  if(!others.length) return alert("No one else online.");
  const target = others[0];

  isCaller = true;
  const callRef = push(ref(db,"calls"));
  callId = callRef.key;
  await set(callRef,{from:myId,to:target,status:"calling"});
  startWebRTC();
};

// 🔔 Listen for calls
onValue(ref(db,"calls"),async snap=>{
  const data=snap.val()||{};
  for(const key in data){
    const c=data[key];
    if(c.to===myId && c.status==="calling"){
      callId=key;
      popup.style.display="flex";
    }
    if(c.from===myId && c.status==="rejected"){
      alert("❌ Call rejected!");
      await remove(ref(db,"calls/"+key));
    }
  }
});

// ✅ Accept / ❌ Reject
acceptBtn.onclick=async()=>{
  popup.style.display="none";
  await update(ref(db,"calls/"+callId),{status:"accepted"});
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  startWebRTC();
};
rejectBtn.onclick=()=>{
  popup.style.display="none";
  update(ref(db,"calls/"+callId),{status:"rejected"});
};

// 🔧 WebRTC Logic
async function startWebRTC(){
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = e=>{
    remoteAudio.srcObject = e.streams[0];
    audioSwitch.style.display="block";
  };
  pc.onicecandidate = e=>{
    if(e.candidate) set(ref(db,`calls/${callId}/ice_${myId}`), e.candidate.toJSON());
  };

  onValue(ref(db,"calls/"+callId), async s=>{
    const d=s.val(); if(!d) return;
    if(d.offer && !isCaller && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      await set(ref(db,`calls/${callId}/answer`), ans);
    } else if(d.answer && isCaller && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
    } else {
      const otherId = isCaller ? d.to : d.from;
      if(d["ice_"+otherId]) await pc.addIceCandidate(new RTCIceCandidate(d["ice_"+otherId]));
    }
  });

  if(isCaller){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await set(ref(db,`calls/${callId}/offer`), offer);
  }

  startBtn.style.display="none";
  hangupBtn.style.display="block";
}

// 📴 Hangup
hangupBtn.onclick=async()=>{
  if(pc) pc.close();
  if(callId) await remove(ref(db,"calls/"+callId));
  hangupBtn.style.display="none";
  startBtn.style.display="block";
  audioSwitch.style.display="none";
};

// 🎧 Speaker toggle
toggleOutput.onclick=async()=>{
  if(!remoteAudio.setSinkId){
    alert("Not supported");
    return;
  }
  const devs=await navigator.mediaDevices.enumerateDevices();
  const outs=devs.filter(d=>d.kind==="audiooutput");
  if(outs.length<2)return alert("No speaker device found");
  isSpeaker=!isSpeaker;
  await remoteAudio.setSinkId(outs[isSpeaker?1:0].deviceId);
  toggleOutput.textContent=isSpeaker?"🎧 Earpiece":"🔊 Speaker";
};
</script>
</body>
</html>
